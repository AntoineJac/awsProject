AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'testAntoineSamConsol

  Sample SAM Template for testAntoineSamConsol

  '
Globals:
  Function:
    Timeout: 3
    Runtime: nodejs14.x
    Architectures:
    - x86_64
Parameters:
  ApiGatewayKey:
    Description: API SMS Gateway Key
    Type: String
    Default: '08e743a0-0d22-4b27-aeb5-9937cb5e1383'
  MCSecret:
    Description: Marketing Cloud JWT Token
    Type: String
    Default: shhhhh
Resources:
  ExecuteEntryFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - lambda:InvokeAsyncs
          - lambda:InvokeFunction
          Resource:
          - '*'
      Environment:
        Variables:
          mcSecret:
            Ref: MCSecret
      CodeUri: ../../lambdas/executeEntry
      Handler: app.lambdaHandler
      Layers:
      - Ref: JsonWebTokenLayer
      Events:
        ExecuteEntry:
          Type: HttpApi
          Properties:
            Path: /execute
            Method: any
  CallSmsApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Environment:
        Variables:
          SmsApiGatewayKey:
            Ref: ApiGatewayKey
          EndpointUrlSMS: https://webhook.site/761ab0e3-ace7-42d4-873c-e12a85a4a4cf
      CodeUri: CallSmsApiFunction
      Handler: app.lambdaHandler
  JsonWebTokenLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: web-token-dependencies
      Description: Dependencies for sam app [web-token]
      ContentUri: ../../dependencies
      CompatibleRuntimes:
      - nodejs6.10
      - nodejs8.10
      - nodejs14.x
      LicenseInfo: MIT
      RetentionPolicy: Retain
Outputs:
  ExecuteApi:
    Description: API Gateway endpoint URL for Prod stage for Execute function
    Value:
      Fn::Sub: https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/
  ExecuteEntryFunction:
    Description: Execute Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ExecuteEntryFunction
      - Arn
  ExecuteEntryFunctionIamRole:
    Description: Implicit IAM Role created for Execute function
    Value:
      Fn::GetAtt:
      - ExecuteEntryFunctionRole
      - Arn
